# 分形系统集成说明

本文档说明如何在 Unity Editor 中设置和集成分形宇宙系统。

## 步骤 1: 创建 FractalSystem GameObject

1. 在 Unity Hierarchy 窗口中，右键点击空白区域
2. 选择 `Create Empty`（创建空对象）
3. 将新创建的对象重命名为 `FractalSystem`

## 步骤 2: 添加 FractalUniverseManager 组件

1. 选中 `FractalSystem` GameObject
2. 在 Inspector 窗口中，点击 `Add Component`（添加组件）
3. 搜索并选择 `Fractal Universe Manager`
4. 组件已添加到 GameObject 上

## 步骤 3: 配置 FractalUniverseManager

在 Inspector 中配置以下字段：

### 阶段配置
- **Stages**: 阶段数据列表
  - 点击 `+` 按钮添加阶段
  - 每个阶段需要引用一个 `HybridStageData` ScriptableObject（见步骤 4）

### 系统依赖
- **Player Controller**: 
  - 在场景中找到带有 `PlayerController` 组件的 GameObject
  - 将其拖拽到此字段中
  - 或者留空，系统会自动查找

- **Chicken Spawner**: 
  - 在场景中找到带有 `ChickenSpawner` 组件的 GameObject
  - 将其拖拽到此字段中
  - 或者留空，系统会自动使用 `ChickenSpawner.Instance`

- **Environment Root**: 
  - 这是环境预制体的父节点
  - 可以创建一个空的 GameObject 作为环境根节点
  - 或者留空，系统会使用 `FractalSystem` 本身作为根节点

### 调试信息
- **Show Debug Logs**: 勾选此选项以在控制台显示调试信息

## 步骤 4: 创建阶段数据资源（HybridStageData）

### 创建阶段资源
1. 在 Project 窗口中，右键点击 `Assets` 文件夹（或你希望存放资源的文件夹）
2. 选择 `Create > ProjectChicken > Fractal Stage`
3. 将新创建的资源重命名为有意义的名称（例如：`Stage_Coop`, `Stage_Farm`）

### 配置阶段数据
对于每个阶段资源，在 Inspector 中配置：

#### 阶段基本信息
- **Stage Name**: 阶段名称（例如："Coop", "Farm"）

#### 过渡类型
- **Transition Type**: 
  - `Expansion`: 扩展模式（摄像机边界变大）
  - `FractalZoom`: 分形缩放模式（重置缩放，加载新世界）

#### 环境预制体
- **Environment Prefab**: 
  - 拖入该阶段的视觉背景/网格预制体
  - 仅用于视觉效果

#### 分形缩放图标（可选）
- **Previous Stage Icon**: 
  - 仅在 `Transition Type == FractalZoom` 时使用
  - 此精灵代表当前阶段在下一个阶段世界中的样子
  - 会在 (0,0) 位置作为地标显示

#### 摄像机约束
- **Min Cam Size**: 摄像机最小尺寸（默认 5）
- **Max Cam Size**: 摄像机最大尺寸（触发下一个阶段的点）
- **Movement Bounds**: 摄像机平移的 +/- X 和 Y 限制

### 示例阶段配置

#### 阶段 0: Coop（鸡舍）
- Stage Name: "Coop"
- Transition Type: Expansion
- Min Cam Size: 5
- Max Cam Size: 10
- Movement Bounds: (5, 5)

#### 阶段 1: Farm（农场）
- Stage Name: "Farm"
- Transition Type: FractalZoom
- Min Cam Size: 5
- Max Cam Size: 15
- Movement Bounds: (10, 10)
- Previous Stage Icon: [Coop 的图标 Sprite]

## 步骤 5: 将阶段添加到 FractalUniverseManager

1. 选中 `FractalSystem` GameObject
2. 在 Inspector 的 `Fractal Universe Manager` 组件中
3. 找到 `Stages` 列表
4. 设置列表大小（例如：2，如果有 2 个阶段）
5. 将创建的阶段资源（`Stage_Coop`, `Stage_Farm` 等）拖拽到对应的槽位中
6. **重要**：确保阶段按顺序排列（阶段 0, 阶段 1, 阶段 2...）

## 步骤 6: 集成到 GameManager

1. 在场景中找到带有 `GameManager` 组件的 GameObject
2. 在 Inspector 中，找到 `GameManager` 组件
3. 找到 `Fractal System` 部分
4. 将 `FractalSystem` GameObject 拖拽到 `Fractal Manager` 字段中
5. 或者留空，系统会自动查找

## 步骤 7: 创建环境预制体（可选）

如果需要为每个阶段创建不同的视觉背景：

1. 在场景中创建环境对象（背景、网格等）
2. 选中所有环境对象
3. 在 Hierarchy 中右键，选择 `Create Empty Parent`
4. 将父对象重命名为有意义的名称（例如：`Environment_Coop`）
5. 将父对象拖拽到 Project 窗口以创建预制体
6. 在阶段数据资源中，将此预制体分配给 `Environment Prefab` 字段

## 验证设置

完成所有步骤后，运行游戏并检查：

1. 控制台应该显示："FractalUniverseManager: 初始化完成，加载阶段 0: [阶段名称]"
2. 摄像机应该受到阶段 0 的约束限制
3. 当摄像机缩放超过 `MaxCamSize` 时，应该触发阶段升级
4. 如果启用了调试日志，控制台会显示阶段过渡信息

## 故障排除

### 问题：找不到 PlayerController 或 ChickenSpawner
- **解决方案**：确保场景中存在这些组件，或者手动在 Inspector 中分配引用

### 问题：阶段升级不触发
- **检查**：
  - 摄像机缩放是否真的超过了 `MaxCamSize`
  - `PlayerController` 是否正确设置了摄像机引用
  - 控制台是否有错误信息

### 问题：环境预制体不显示
- **检查**：
  - 预制体是否正确分配给阶段数据
  - `Environment Root` 是否正确设置
  - 预制体是否包含可见的渲染组件（SpriteRenderer 等）

## 可选：生产倍率系统

如果需要在阶段升级时应用生产倍率：

1. 在 `ResourceManager` 中添加生产倍率字段和方法
2. 在 `GameManager.ApplyFractalProductionMultiplier()` 中调用相应的方法
3. 在 `FractalUniverseManager` 的阶段升级逻辑中调用 `GameManager.Instance.ApplyFractalProductionMultiplier()`

示例代码（在 ResourceManager 中）：
```csharp
private float productionMultiplier = 1f;

public void SetProductionMultiplier(float multiplier)
{
    productionMultiplier = multiplier;
    Debug.Log($"ResourceManager: 生产倍率设置为 {multiplier}x");
}

public float GetProductionMultiplier() => productionMultiplier;
```

然后在 `AddEgg()` 方法中应用倍率：
```csharp
public void AddEgg(int amount)
{
    int finalAmount = Mathf.RoundToInt(amount * productionMultiplier);
    CurrentSessionEggs += finalAmount;
    UpdateUI();
}
```

