# 场地系统使用说明

## 概述

场地系统已经重构，现在支持：
- 鸡在场地内活动
- 更换场地美术素材
- 设置鸡活动范围
- 基于鸡数量的自动升级
- 永久保存场地升级状态
- 两种升级类型：场地扩大 或 分形缩放

## 系统架构

### 1. AreaData (ScriptableObject)
场地数据资源，定义每个场地的配置。

### 2. AreaUpgradeManager (MonoBehaviour)
场地升级管理器，负责：
- 检测鸡数量是否溢出
- 自动升级场地
- 保存和加载场地等级
- 应用场地配置

### 3. PlayArea (MonoBehaviour)
场地组件，负责：
- 定义场地边界
- 显示场地背景
- 提供边界检测方法

## 设置步骤

### 步骤 1: 创建场地数据资源

1. 在 Project 窗口中右键点击
2. 选择 `Create > ProjectChicken > Area Data`
3. 重命名为有意义的名称（例如：`Area_Coop`, `Area_Farm`）

### 步骤 2: 配置场地数据

对于每个场地数据资源，在 Inspector 中配置：

#### 基本信息
- **Area Name**: 场地名称（例如："鸡舍", "农场"）

#### 场地配置
- **Area Size**: 场地大小（世界单位），例如 (10, 10)
- **Area Center**: 场地中心位置（世界坐标），通常为 (0, 0)

#### 美术素材
- **Background Sprite**: 场地背景 Sprite

#### 升级配置
- **Upgrade Type**: 
  - `Expand`: 场地尺寸扩大（下一个场地会更大）
  - `FractalZoom`: 摄像机拉远，穿过云层，更换场地
- **Chicken Count Threshold**: 触发升级所需的鸡数量阈值

#### 摄像机约束（仅 FractalZoom 类型需要）
- **Min Cam Size**: 摄像机最小尺寸
- **Max Cam Size**: 摄像机最大尺寸
- **Movement Bounds**: 摄像机平移限制

### 步骤 3: 创建 AreaUpgradeManager

1. 在场景中创建空 GameObject，命名为 `AreaUpgradeManager`
2. 添加 `AreaUpgradeManager` 组件
3. 在 Inspector 中配置：
   - **Area Data List**: 添加所有场地数据（按升级顺序）
   - **Play Area**: 拖入场景中的 PlayArea GameObject（或留空自动查找）
   - **Chicken Spawner**: 拖入 ChickenSpawner（或留空自动查找）
   - **Player Controller**: 拖入 PlayerController（或留空自动查找）

### 步骤 4: 配置 PlayArea

1. 在场景中找到或创建 PlayArea GameObject
2. 确保 PlayArea 组件已添加
3. 配置初始设置（这些会在场地升级时被覆盖）

## 如何将 AreaData 应用到 PlayArea

### 方法 1: 自动应用（推荐，游戏运行时）

**这是默认方式，无需手动操作。**

`AreaUpgradeManager` 会在以下情况自动应用 `AreaData` 到 `PlayArea`：

1. **游戏启动时**：
   - `AreaUpgradeManager` 在 `Start()` 时自动应用第一个场地（等级 0）
   - 如果有存档，会加载保存的场地等级并应用对应的 `AreaData`

2. **场地升级时**：
   - 当鸡数量满足升级条件时，自动应用下一个场地的 `AreaData`
   - 升级是永久性的，会自动保存

**设置方式**：
- 确保 `AreaUpgradeManager` 的 `Area Data List` 中包含了所有场地数据（按顺序）
- 确保 `Play Area` 字段已正确引用（或留空让系统自动查找）

### 方法 2: 手动应用（编辑器测试/预览）

如果你想在编辑器中手动测试不同的 `AreaData` 配置，可以使用以下方法：

#### 方式 A: 通过代码手动应用（推荐用于测试）

1. **创建测试脚本**（临时）：

```csharp
using UnityEngine;
using ProjectChicken.Systems;

public class TestAreaData : MonoBehaviour
{
    public AreaData testAreaData;
    public PlayArea playArea;

    [ContextMenu("应用 AreaData")]
    public void ApplyTestAreaData()
    {
        if (testAreaData == null || playArea == null)
        {
            Debug.LogError("请先设置 testAreaData 和 playArea！");
            return;
        }

        Vector2 chickenAreaSize = testAreaData.ChickenMovementAreaSize;
        Vector2 chickenAreaCenter = testAreaData.ChickenMovementAreaCenter;

        playArea.UpdateAreaSettings(
            testAreaData.AreaSize,
            testAreaData.AreaCenter,
            testAreaData.BackgroundSprite,
            chickenAreaSize != Vector2.zero ? chickenAreaSize : default(Vector2),
            chickenAreaCenter != Vector2.zero ? chickenAreaCenter : default(Vector2)
        );

        Debug.Log($"已手动应用 AreaData: {testAreaData.AreaName}");
    }
}
```

2. **使用方法**：
   - 将脚本添加到场景中的任意 GameObject
   - 在 Inspector 中设置 `Test Area Data` 和 `Play Area` 引用
   - 右键点击组件，选择 `应用 AreaData`（或点击 Inspector 中的按钮）

#### 方式 B: 使用 AreaUpgradeManager 的公共方法（推荐）

`AreaUpgradeManager` 已经提供了两个公共方法，可以直接使用：

**方法 1: `SetAreaLevel(int level, bool saveToDisk = true)`**
- 切换到指定场地等级
- 参数：
  - `level`: 目标场地等级（从 0 开始）
  - `saveToDisk`: 是否保存到存档（默认 true）

**方法 2: `ApplyAreaDataManually(AreaData areaData)`**
- 直接应用指定的 AreaData（不改变当前等级，不保存）
- 适合在编辑器中预览不同场地效果

**使用示例**：

```csharp
// 切换到场地等级 1（并保存）
AreaUpgradeManager.Instance.SetAreaLevel(1);

// 切换到场地等级 0（不保存，仅临时预览）
AreaUpgradeManager.Instance.SetAreaLevel(0, saveToDisk: false);

// 直接应用某个 AreaData（不保存）
AreaData myAreaData = // ... 获取 AreaData 引用
AreaUpgradeManager.Instance.ApplyAreaDataManually(myAreaData);
```

#### 方式 C: 通过 Unity Editor 扩展（高级）

可以创建一个自定义编辑器窗口，但这需要更多设置。对于测试，方式 B 更简单。

### 方法 3: 在 Inspector 中使用 Context Menu（开发中）

你可以在 `AreaUpgradeManager` 组件上右键，通过上下文菜单快速切换场地。这需要在代码中添加 `[ContextMenu]` 属性（可选功能）。

### 应用流程说明

无论使用哪种方法，应用 `AreaData` 的过程都是相同的：

```
AreaData → PlayArea.UpdateAreaSettings() → 更新以下内容：
  ├─ 场地大小 (AreaSize)
  ├─ 场地中心 (AreaCenter)
  ├─ 背景 Sprite (BackgroundSprite)
  ├─ 鸡活动范围大小 (ChickenMovementAreaSize)
  ├─ 鸡活动范围中心 (ChickenMovementAreaCenter)
  └─ SpriteRenderer 显示更新
```

### 验证应用是否成功

1. **查看控制台日志**：
   - 如果 `AreaUpgradeManager` 的 `Show Debug Logs` 已启用
   - 会看到类似：`AreaUpgradeManager: 已应用场地 - 鸡舍 (等级 0)`

2. **在 Scene 视图中查看 Gizmos**：
   - 绿色线条：场地边界
   - 黄色虚线：鸡活动范围（如果不同）
   - 应该能看到边界已更新

3. **在 Game 视图中查看**：
   - 背景 Sprite 应该已更换
   - 场地大小应该已更新

### 常见问题

**Q: 为什么我修改了 AreaData，但 PlayArea 没有变化？**

A: 
- 确保 `AreaUpgradeManager` 正在运行（游戏在 Play 模式）
- 检查 `AreaUpgradeManager` 的 `Area Data List` 是否包含了你的 `AreaData`
- 如果是在编辑器模式下，需要手动应用（使用方法 2）

**Q: 如何预览不同场地的效果？**

A: 使用方法 2（手动应用），可以快速切换不同的 `AreaData` 来预览效果

**Q: 场地升级后会自动保存吗？**

A: 是的，通过 `AreaUpgradeManager` 自动升级的场地会立即保存到存档中

**Q: 可以跳过某些场地等级吗？**

A: 可以，使用 `AreaUpgradeManager.Instance.SetAreaLevel(level)` 方法直接跳转到指定等级

**Q: 如何快速预览不同场地的效果？**

A: 有两个方法：
1. 使用 `AreaUpgradeManager.Instance.SetAreaLevel(level, saveToDisk: false)` 临时切换
2. 使用 `AreaUpgradeManager.Instance.ApplyAreaDataManually(areaData)` 直接应用指定的 AreaData

**Q: 手动应用的场地会保存吗？**

A: 取决于使用的方法：
- `SetAreaLevel(level, saveToDisk: true)` - 会保存（默认）
- `SetAreaLevel(level, saveToDisk: false)` - 不会保存
- `ApplyAreaDataManually(areaData)` - 不会保存，不会改变当前等级

## 工作流程

### 自动升级流程

1. **检测阶段**：
   - `AreaUpgradeManager` 在 `Update()` 中持续检测鸡数量
   - 当鸡数量 >= 下一个场地的 `ChickenCountThreshold` 时触发升级

2. **升级阶段**：
   - 升级到下一个场地等级
   - 应用新场地的配置（大小、中心、背景）
   - 如果是 `FractalZoom` 类型，更新摄像机约束
   - 保存场地等级到存档

3. **应用阶段**：
   - 更新 `PlayArea` 的大小和背景
   - 鸡自动适应新的场地边界
   - 新生成的鸡会在新场地内生成

### 保存和加载

- **保存**：场地等级自动保存到 `GameSaveData`
- **加载**：游戏启动时从存档加载场地等级
- **永久性**：场地升级是永久的，跨回合保存

## 升级类型说明

### Expand（场地扩大）
- 下一个场地的尺寸更大
- 鸡的活动范围扩大
- 背景 Sprite 更换
- 摄像机约束可能更新

### FractalZoom（分形缩放）
- 摄像机拉远，穿过云层
- 完全更换场地环境
- 更新摄像机约束（最小/最大缩放、平移限制）
- 视觉效果更震撼

## 示例配置

### 场地 0: 鸡舍 (Coop)
- Area Name: "鸡舍"
- Area Size: (10, 10)
- Background Sprite: [鸡舍背景]
- Upgrade Type: Expand
- Chicken Count Threshold: 10

### 场地 1: 农场 (Farm)
- Area Name: "农场"
- Area Size: (20, 20)
- Background Sprite: [农场背景]
- Upgrade Type: FractalZoom
- Chicken Count Threshold: 25
- Min Cam Size: 5
- Max Cam Size: 15
- Movement Bounds: (10, 10)

## 注意事项

1. **场地数据顺序**：确保 `Area Data List` 中的场地按升级顺序排列
2. **鸡数量阈值**：每个场地的阈值应该递增
3. **背景 Sprite**：确保每个场地都有对应的背景 Sprite
4. **FractalZoom 类型**：需要配置摄像机约束，否则可能无法正常工作
5. **保存系统**：场地等级会自动保存，无需手动操作

## 调试

- 启用 `Show Debug Logs` 查看详细日志
- 检查控制台输出，确认场地升级是否触发
- 使用 Scene 视图的 Gizmos 查看场地边界

## 可视化（Gizmos）使用指南

在 Unity Scene 视图中，你可以看到场地和鸡活动范围的可视化：

### 启用可视化步骤

1. **选中 PlayArea GameObject**
   - 在 Hierarchy 窗口中找到 `PlayArea` GameObject
   - 点击选中它

2. **启用 Gizmos 显示**
   - 在 PlayArea 组件的 Inspector 中，找到 "可视化（可选）" 部分
   - 勾选 **Show Gizmos** 复选框

3. **启用 Scene 视图的 Gizmos**
   - 打开 Scene 视图（`Window > General > Scene`）
   - 在 Scene 视图的工具栏上，找到 **Gizmos** 按钮（图标是一个圆形网格）
   - 点击 **Gizmos** 按钮，确保它被启用（按钮会高亮显示）

4. **（可选）调整 Gizmos 颜色**
   - 在 PlayArea 组件的 Inspector 中，找到 **Gizmo Color** 字段
   - 点击颜色框，可以自定义场地边界的显示颜色（默认为绿色）

### 可视化说明

- **绿色线条**：场地边界（背景显示的范围）
  - 这是场地的完整大小，背景 Sprite 会显示在这个范围内

- **黄色线条**：鸡活动范围（仅在鸡活动范围与场地范围不同时显示）
  - 如果鸡活动范围大小和位置与场地相同，则不会显示黄色线条
  - 如果设置了不同的鸡活动范围，黄色线条会显示鸡实际可以活动的区域

### 示例场景

#### 场景 1：场地和鸡活动范围相同
- 只显示**绿色线条**（场地边界）
- 鸡可以在整个场地内活动

#### 场景 2：鸡活动范围小于场地
- 显示**绿色线条**（场地边界，更大的范围）
- 显示**黄色线条**（鸡活动范围，较小的范围）
- 鸡只能在黄色线条围成的区域内活动

### 调试技巧

1. **实时查看**：在 Play 模式下，Gizmos 会实时更新，你可以看到：
   - 场地边界是否正确
   - 鸡活动范围是否正确
   - 鸡是否超出了活动范围

2. **多场地对比**：在 Edit 模式下，可以：
   - 调整不同场地的 `AreaData` 配置
   - 查看 Gizmos 如何变化
   - 验证配置是否正确

3. **诊断问题**：
   - 如果看不到 Gizmos，检查：
     - ✅ `Show Gizmos` 是否勾选
     - ✅ Scene 视图的 Gizmos 按钮是否启用
     - ✅ PlayArea GameObject 是否被选中（Gizmos 通常只在选中对象时显示）

## 与旧系统的兼容性

- `PlayArea` 保持向后兼容
- `FractalUniverseManager` 可以继续使用（但建议迁移到新系统）
- 旧的场地配置可以逐步迁移到新的 `AreaData` 系统

